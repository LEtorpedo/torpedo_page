# Torpedo Blog Backend Makefile
# ä½¿ç”¨ uv è¿›è¡ŒåŒ…ç®¡ç†çš„å¿«æ·å‘½ä»¤

.PHONY: help setup install format lint test test-env serve clean check add add-dev update deps requirements docker-build docker-run docker-compose-up docker-compose-down docker-compose-logs

# é»˜è®¤ç›®æ ‡
help:
	@echo "ğŸš€ Torpedo Blog Backend å¼€å‘å‘½ä»¤"
	@echo ""
	@echo "ğŸ“¦ ç¯å¢ƒç®¡ç†:"
	@echo "  setup     - åˆå§‹åŒ–å¼€å‘ç¯å¢ƒ"
	@echo "  install   - å®‰è£…ä¾èµ–"
	@echo ""
	@echo "ğŸ¨ ä»£ç è´¨é‡:"
	@echo "  format    - æ ¼å¼åŒ–ä»£ç "
	@echo "  lint      - ä»£ç è´¨é‡æ£€æŸ¥"
	@echo "  check     - å®Œæ•´æ£€æŸ¥æµç¨‹ (format + lint + test)"
	@echo ""
	@echo "ğŸ§ª æµ‹è¯•:"
	@echo "  test      - è¿è¡Œæµ‹è¯•"
	@echo "  test-env  - æµ‹è¯•ç¯å¢ƒé…ç½®"
	@echo ""
	@echo "ğŸš€ è¿è¡Œ:"
	@echo "  serve     - å¯åŠ¨å¼€å‘æœåŠ¡å™¨"
	@echo ""
	@echo "ğŸ§¹ æ¸…ç†:"
	@echo "  clean     - æ¸…ç†é¡¹ç›®æ–‡ä»¶"
	@echo ""
	@echo "ğŸ³ Docker:"
	@echo "  docker-build        - æ„å»º Docker é•œåƒ"
	@echo "  docker-run          - è¿è¡Œ Docker å®¹å™¨"
	@echo "  docker-compose-up   - å¯åŠ¨ Docker Compose"
	@echo "  docker-compose-down - åœæ­¢ Docker Compose"
	@echo ""
	@echo "ğŸ“š ç¤ºä¾‹:"
	@echo "  make setup    # åˆå§‹åŒ–é¡¹ç›®"
	@echo "  make serve    # å¯åŠ¨æœåŠ¡å™¨"
	@echo "  make check    # å®Œæ•´æ£€æŸ¥"

# åˆå§‹åŒ–å¼€å‘ç¯å¢ƒ
setup:
	@echo "ğŸš€ åˆå§‹åŒ–å¼€å‘ç¯å¢ƒ..."
	@if [ ! -f .env ]; then \
		if [ -f env.example ]; then \
			cp env.example .env; \
			echo "âœ… å·²å¤åˆ¶ç¯å¢ƒå˜é‡æ¨¡æ¿"; \
			echo "âš ï¸  è¯·ç¼–è¾‘ .env æ–‡ä»¶è®¾ç½®ç¯å¢ƒå˜é‡"; \
		else \
			echo "âŒ æœªæ‰¾åˆ° env.example æ–‡ä»¶"; \
			exit 1; \
		fi; \
	fi
	uv venv
	uv sync --all-extras
	@echo "ğŸ‰ å¼€å‘ç¯å¢ƒåˆå§‹åŒ–å®Œæˆï¼"

# å®‰è£…ä¾èµ–
install:
	uv sync --all-extras

# æ ¼å¼åŒ–ä»£ç 
format:
	@echo "ğŸ¨ æ ¼å¼åŒ–ä»£ç ..."
	uv run black .
	uv run isort .

# ä»£ç è´¨é‡æ£€æŸ¥
lint:
	@echo "ğŸ” ä»£ç è´¨é‡æ£€æŸ¥..."
	uv run flake8 .
	uv run mypy .

# è¿è¡Œæµ‹è¯•
test:
	@echo "ğŸ§ª è¿è¡Œæµ‹è¯•..."
	uv run pytest --cov=app --cov-report=term-missing

# æµ‹è¯•ç¯å¢ƒé…ç½®
test-env:
	uv run python test_setup.py

# å¯åŠ¨å¼€å‘æœåŠ¡å™¨
serve:
	@echo "ğŸš€ å¯åŠ¨å¼€å‘æœåŠ¡å™¨..."
	uv run uvicorn app.main:app --reload --port 8000

# æ¸…ç†é¡¹ç›®
clean:
	@echo "ğŸ§¹ æ¸…ç†é¡¹ç›®..."
	find . -type d -name '__pycache__' -exec rm -rf {} + 2>/dev/null || true
	find . -type f -name '*.pyc' -delete 2>/dev/null || true
	rm -rf .coverage htmlcov/ .pytest_cache/ 2>/dev/null || true
	@echo "âœ… æ¸…ç†å®Œæˆ"

# å®Œæ•´æ£€æŸ¥æµç¨‹
check: format lint test
	@echo "ğŸ‰ æ‰€æœ‰æ£€æŸ¥å®Œæˆï¼"

# æ·»åŠ ä¾èµ– (ä½¿ç”¨æ–¹å¼: make add PACKAGE=fastapi)
add:
	@if [ -z "$(PACKAGE)" ]; then \
		echo "âŒ è¯·æŒ‡å®šåŒ…å: make add PACKAGE=package-name"; \
		exit 1; \
	fi
	uv add $(PACKAGE)

# æ·»åŠ å¼€å‘ä¾èµ– (ä½¿ç”¨æ–¹å¼: make add-dev PACKAGE=pytest)
add-dev:
	@if [ -z "$(PACKAGE)" ]; then \
		echo "âŒ è¯·æŒ‡å®šåŒ…å: make add-dev PACKAGE=package-name"; \
		exit 1; \
	fi
	uv add --dev $(PACKAGE)

# æ›´æ–°ä¾èµ–
update:
	uv lock --upgrade

# æ˜¾ç¤ºä¾èµ–æ ‘
deps:
	uv tree

# ç”Ÿæˆ requirements.txt (å…¼å®¹æ€§)
requirements:
	uv export --format requirements-txt --output-file requirements.txt
	@echo "âœ… å·²ç”Ÿæˆ requirements.txt"

# Docker ç›¸å…³å‘½ä»¤
docker-build:
	@echo "ğŸ³ æ„å»º Docker é•œåƒ..."
	docker build -t torpedo-blog-backend .

docker-run:
	@echo "ğŸš€ è¿è¡Œ Docker å®¹å™¨..."
	docker run -p 8000:8000 --env-file .env torpedo-blog-backend

docker-compose-up:
	@echo "ğŸ³ å¯åŠ¨ Docker Compose æœåŠ¡..."
	docker-compose up -d

docker-compose-down:
	@echo "ğŸ›‘ åœæ­¢ Docker Compose æœåŠ¡..."
	docker-compose down

docker-compose-logs:
	@echo "ğŸ“‹ æŸ¥çœ‹ Docker Compose æ—¥å¿—..."
	docker-compose logs -f api 